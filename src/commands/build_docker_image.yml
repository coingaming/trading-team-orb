description: >
  Build and Push Docker Image
parameters:
  full_version:
    type: string
  repository_name:
    type: string
  base_path:
    type: string
    default: "."
steps:
  - run:
      name: "Initializing docker buildx"
      command: |
        docker version
        docker buildx version
        docker buildx create --use
  - run:
      name: "Logging in to AWS ECR"
      command: |
        aws ecr get-login-password --region $AWS_DEFAULT_REGION | docker login --username AWS --password-stdin $AWS_ACCOUNT_ID.dkr.ecr.$AWS_DEFAULT_REGION.amazonaws.com
  - run:
      name: "Running docker build"
      command: |
        cd <<parameters.base_path>>
        if [ <<parameters.base_path>> != "." ]; then cp -R /home/circleci/project/app .; fi
        docker buildx build \
          --platform linux/amd64,linux/arm64 \
          -f CircleDockerfile . \
          -t $AWS_ACCOUNT_ID.dkr.ecr.$AWS_DEFAULT_REGION.amazonaws.com/<<parameters.repository_name>>:<<parameters.full_version>> \
          --push
        echo "Docker image built and pushed: <<parameters.repository_name>>:<<parameters.full_version>>"
