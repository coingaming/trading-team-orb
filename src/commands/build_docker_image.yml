description: >
  Build Docker Image
parameters:
  full_version:
    type: string
  repository_name:
    type: string
  base_path:
    type: string
    default: "."
steps:
  - run:
      name: "Enable buildx"
      command: |
        echo "Path: <<parameters.base_path>>"
        if [ <<parameters.base_path>> != "." ]; then
          cd <<parameters.base_path>>;
        fi
        # Clean up any existing builders
        docker buildx rm --all 2>/dev/null || true
        # Create a new builder instance and use it
        docker buildx create --use --name circleci-builder --driver docker-container
        # Initialize the builder
        docker buildx inspect --bootstrap
  - run:
      name: "Authorize in AWS ECR"
      command: |
        aws ecr get-login-password --region $AWS_DEFAULT_REGION | docker login --username AWS --password-stdin $AWS_ACCOUNT_ID.dkr.ecr.$AWS_DEFAULT_REGION.amazonaws.com
  - run:
      name: Add github.com to known hosts
      command: ssh-keyscan github.com >> ~/.ssh/known_hosts
  - run:
      name: "Running docker build"
      command: |
        echo "Path: <<parameters.base_path>>"
        if [ <<parameters.base_path>> != "." ]; then
          cd <<parameters.base_path>>;
          cp -R /home/circleci/project/app .;
        fi
        docker buildx build \
          --platform linux/amd64,linux/arm64 \
          -f CircleDockerfile . \
          -t $AWS_ACCOUNT_ID.dkr.ecr.$AWS_DEFAULT_REGION.amazonaws.com/<<parameters.repository_name>>:<<parameters.full_version>> \
          --push
        echo "Image built and pushed: <<parameters.repository_name>>:<<parameters.full_version>>"
